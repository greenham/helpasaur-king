services:
  # Production-specific configurations with ghcr.io images
  # No port mappings needed - base compose no longer exposes ports,
  # and only nginx (below) binds to 80/443 for public traffic.

  api-server:
    image: ghcr.io/greenham/helpasaur-king/helpa-api:${VERSION:-latest}

  discord-bot:
    image: ghcr.io/greenham/helpasaur-king/helpa-discord:${VERSION:-latest}

  twitch-bot:
    image: ghcr.io/greenham/helpasaur-king/helpa-twitch:${VERSION:-latest}

  runnerwatcher:
    image: ghcr.io/greenham/helpasaur-king/helpa-runnerwatcher:${VERSION:-latest}

  racebot:
    image: ghcr.io/greenham/helpasaur-king/helpa-racebot:${VERSION:-latest}

  ws-relay:
    image: ghcr.io/greenham/helpasaur-king/helpa-ws-relay:${VERSION:-latest}

  # Infrastructure overrides
  mongo:
    ports:
      - 127.0.0.1:27017:27017
    networks:
      - int
      - ext
    volumes:
      - ./docker-entrypoint-initdb.d/db-init.prod.js:/docker-entrypoint-initdb.d/db-init.prod.js:ro

  # Disable Mongo Express in production
  mongo-express:
    deploy:
      replicas: 0

  nginx:
    ports:
      - 80:80
      - 443:443
    volumes:
      - /etc/letsencrypt/live/api.helpasaur.com/fullchain.pem:/etc/nginx/certs/api.helpasaur.com/fullchain.pem
      - /etc/letsencrypt/live/api.helpasaur.com/privkey.pem:/etc/nginx/certs/api.helpasaur.com/privkey.pem
      - /etc/letsencrypt/live/rw.helpasaur.com/fullchain.pem:/etc/nginx/certs/rw.helpasaur.com/fullchain.pem
      - /etc/letsencrypt/live/rw.helpasaur.com/privkey.pem:/etc/nginx/certs/rw.helpasaur.com/privkey.pem
      - /etc/letsencrypt/live/static.helpasaur.com/fullchain.pem:/etc/nginx/certs/static.helpasaur.com/fullchain.pem
      - /etc/letsencrypt/live/static.helpasaur.com/privkey.pem:/etc/nginx/certs/static.helpasaur.com/privkey.pem
      - ./nginx/ssl:/etc/nginx/ssl
      - ./nginx/nginx.prod.conf:/etc/nginx/conf.d/default.conf